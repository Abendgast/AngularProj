<div class="wrap" *ngIf="(state$ | async) as s">
  <header class="header">
    <h1>üß© Fix the Interface</h1>
    <p class="subtitle">Debug broken UI elements to advance through levels</p>
    <div class="hud">
      <div class="hud-item">
        <div class="hud-icon">‚è±Ô∏è</div>
        <div class="hud-value">{{ s.timeLeft }}s</div>
      </div>
      <div class="hud-item">
        <div class="hud-icon">üèÜ</div>
        <div class="hud-value">{{ s.score }}</div>
      </div>
      <div class="hud-item">
        <div class="hud-icon">‚öôÔ∏è</div>
        <div class="hud-value">Level {{ s.level }}</div>
      </div>
      <div class="hud-item">
        <div class="hud-icon">üëë</div>
        <div class="hud-value">{{ bestScore() }}</div>
      </div>
    </div>
  </header>

  <nav class="controls">
    <button class="btn btn-primary" (click)="start()" [disabled]="s.running">
      <span class="btn-icon">‚ñ∂</span> Start
    </button>
    <button class="btn btn-secondary" (click)="stop()" [disabled]="!s.running">
      <span class="btn-icon">‚èπ</span> Stop
    </button>
    <button class="btn btn-hint" (click)="useHint()" [disabled]="!s.running">
      <span class="btn-icon">üí°</span> Hint (-8s)
    </button>
  </nav>

  <section class="board" *ngIf="s.elements?.length">
    <div
      class="tile"
      *ngFor="let el of s.elements; let i = index"
      [class.fixed]="el.fixed"
      [class.blur]="el.ui?.blurred"
      [style.transform]="'rotate(' + (el.ui?.rotation || 0) + 'deg)'"
      draggable="true"
      (dragstart)="dragStart($event, el)"
      (drop)="drop($event, el)"
      (dragover)="allowDrop($event)"
      (click)="clickElement(el, $event)"
      (dblclick)="rotateElement(el, $event)"
      [title]="el.hint + (el.fixed ? ' ‚úì FIXED' : '')"
    >
      <div class="tile-header">
        <small class="type">{{ el.type }}</small>
        <small class="diff">{{ 'star'.repeat(el.difficulty) }}</small>
      </div>

      <div class="tile-body">
        <ng-container [ngSwitch]="el.type">
          <!-- BUTTON: Must click to activate (clickBroken) -->
          <button
            *ngSwitchCase="'button'"
            class="inner-btn"
            [disabled]="el.ui?.disabled"
            (click)="$event.stopPropagation()"
          >
            {{ el.fixed ? '‚úì Fixed' : 'Click me' }}
          </button>

          <!-- INPUT: Type the exact text (textBroken) -->
          <input
            *ngSwitchCase="'input'"
            type="text"
            class="inner-input"
            [placeholder]="el.brokenProps.textBroken ? 'Type: ' + el.brokenProps.textBroken.expected : 'Type...'"
            [value]="el.ui?.currentText"
            (input)="onTextChange(el, $any($event.target).value)"
            (dragstart)="onInputDragStart($event)"
            [disabled]="el.ui?.disabled"
            (click)="$event.stopPropagation()"
          />

          <!-- CARD: Interactive element with color picker and text -->
          <div *ngSwitchCase="'card'" class="card" (click)="$event.stopPropagation()">
            <div class="card-title">{{ el.fixed ? '‚úì Fixed' : 'Card' }}</div>
            <div class="card-controls">
              <div *ngIf="el.brokenProps.colorWrong" class="color-picker">
                <input
                  type="color"
                  [value]="el.ui?.currentColor"
                  (input)="onColorPick(el, $any($event.target).value)"
                  (click)="$event.stopPropagation()"
                />
              </div>
              <div *ngIf="el.brokenProps.textBroken" class="text-input">
                <input
                  type="text"
                  [placeholder]="'Fix: ' + el.brokenProps.textBroken.expected"
                  (input)="onTextChange(el, $any($event.target).value)"
                  (click)="$event.stopPropagation()"
                  (dragstart)="onInputDragStart($event)"
                />
              </div>
            </div>
          </div>

          <!-- SLIDER: Drag to exact position (sliderBroken) -->
          <div *ngSwitchCase="'slider'" class="slider-container" (click)="$event.stopPropagation()">
            <input
              type="range"
              min="0"
              max="100"
              [value]="el.ui?.sliderValue || 0"
              (input)="onSliderChange(el, $any($event.target).value)"
              class="slider"
            />
            <span class="slider-value">{{ el.ui?.sliderValue || 0 }}</span>
          </div>

          <!-- LABEL: Read-only, just needs to be fixed -->
          <div *ngSwitchCase="'label'" class="label-box" (click)="$event.stopPropagation()">
            <span class="label-text">{{ el.fixed ? '‚úì OK' : 'Read me' }}</span>
          </div>

          <!-- IMAGE: Gallery/decorative (click to show) -->
          <div *ngSwitchCase="'image'" class="image-container" (click)="$event.stopPropagation()">
            <img
              [src]="'https://picsum.photos/seed/' + el.id + '/100/80?blur=5'"
              alt="tile image"
              class="tile-image"
            />
          </div>
        </ng-container>
      </div>

      <div class="tile-footer">
        <small class="status">{{ el.fixed ? '‚úì' : '‚úó' }}</small>
        <small class="order">pos: {{ el.ui?.orderIndex }}</small>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div *ngIf="s.message" class="message">{{ s.message }}</div>
    <div *ngIf="!s.running && !s.message" class="hint-text">
      {{ isLevelComplete(s.elements) ? 'All fixed! Click Start to continue.' : 'Click Start to begin.' }}
    </div>
  </footer>
</div>
